<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - ShopMart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Icons:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-light">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-lg">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">
                <i class="material-icons">store</i> ShopMart
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="shop.html">Shop</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link position-relative" href="cart.html">
                            <i class="material-icons">shopping_cart</i>
                            <span id="cart-count" class="badge bg-danger position-absolute top-0 start-100 translate-middle" style="display: none;">0</span>
                        </a>
                    </li>
                    <li class="nav-item" id="loginLink">
                        <a class="nav-link" href="login.html">Login</a>
                    </li>
                    <li class="nav-item" id="logoutLink" style="display: none;">
                        <a class="nav-link" href="#" onclick="logout()">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Checkout Header -->
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-5">
                    <div>
                        <h1 class="mb-1">
                            <i class="material-icons text-success">payment</i>
                            Checkout
                        </h1>
                        <p class="text-muted mb-0">Review your order and complete payment</p>
                    </div>
                    <a href="cart.html" class="btn btn-outline-secondary btn-lg px-4">
                        <i class="material-icons">arrow_back</i> Back to Cart
                    </a>
                </div>
            </div>
        </div>

        <div class="row g-5">
            <!-- Order Summary -->
            <div class="col-lg-8">
                <div class="card shadow-lg border-0 rounded-4">
                    <div class="card-header bg-gradient-success text-white py-4">
                        <h5 class="mb-0">
                            <i class="material-icons me-2">shopping_bag</i>
                            Order Summary
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="checkoutItems" class="p-4">
                            <!-- Items will be loaded here -->
                        </div>
                        <div class="card-footer bg-light border-0 py-4">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="mb-0 fw-bold text-success">
                                        Total: $<span id="checkoutTotal">0.00</span>
                                    </h5>
                                </div>
                                <div class="col-md-6 text-end">
                                    <span class="badge bg-success fs-6 px-3 py-2">Secure Checkout</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Form -->
            <div class="col-lg-4">
                <div class="card shadow-lg border-0 rounded-4 sticky-top" style="top: 20px;">
                    <div class="card-header bg-gradient-primary text-white py-4">
                        <h5 class="mb-0">
                            <i class="material-icons me-2">credit_card</i>
                            Payment Details
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <form id="paymentForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Card Number</label>
                                <div class="input-group input-group-outline">
                                    <span class="input-group-text border-0">
                                        <i class="material-icons">credit_card</i>
                                    </span>
                                    <input type="text" class="form-control" id="cardNumber" 
                                           placeholder="1234 5678 9012 3456" maxlength="19" required>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label fw-bold">Expiry</label>
                                    <div class="input-group input-group-outline">
                                        <input type="text" class="form-control" id="expiryDate" 
                                               placeholder="MM/YY" maxlength="5" required>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label fw-bold">CVV</label>
                                    <div class="input-group input-group-outline">
                                        <input type="text" class="form-control" id="cvv" 
                                               placeholder="123" maxlength="4" required>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4 mt-3">
                                <label class="form-label fw-bold">Name on Card</label>
                                <div class="input-group input-group-outline">
                                    <span class="input-group-text border-0">
                                        <i class="material-icons">person</i>
                                    </span>
                                    <input type="text" class="form-control" id="cardName" 
                                           placeholder="John Doe" required>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-success btn-lg w-100 py-3 shadow-lg">
                                <i class="material-icons">check_circle</i>
                                Complete Payment
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Snackbar -->
    <div id="snackbar" class="snackbar"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/cart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            updateCartCount();
            loadCheckout();
        });

        function loadCheckout() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const checkoutItems = document.getElementById('checkoutItems');
            const checkoutTotal = document.getElementById('checkoutTotal');

            if (cart.length === 0) {
                checkoutItems.innerHTML = `
                    <div class="text-center py-5">
                        <i class="material-icons display-1 text-muted">shopping_cart</i>
                        <h5 class="mt-3 text-muted">Your cart is empty</h5>
                        <a href="shop.html" class="btn btn-primary mt-3">Start Shopping</a>
                    </div>
                `;
                return;
            }

            let total = 0;
            let itemsHTML = '';

            cart.forEach(item => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                itemsHTML += `
                    <div class="d-flex align-items-center p-3 border-bottom">
                        <img src="${item.image}" class="cart-item-img rounded-3 me-3" alt="${item.name}">
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-bold">${item.name}</h6>
                            <p class="mb-1 text-muted small">$${item.price.toFixed(2)} × ${item.quantity}</p>
                            <p class="mb-0 fw-bold text-success">$${subtotal.toFixed(2)}</p>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.id})">
                            <i class="material-icons">delete</i>
                        </button>
                    </div>
                `;
            });

            checkoutItems.innerHTML = itemsHTML;
            checkoutTotal.textContent = total.toFixed(2);

            // Card number formatting
            document.getElementById('cardNumber').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formatted;
            });

            // Expiry date formatting
            document.getElementById('expiryDate').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });
        }

        // Payment form submission
        document.getElementById('paymentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (cart.length === 0) {
                showSnackbar('Cart is empty', 'error');
                return;
            }

            // Simulate payment processing
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="material-icons">hourglass_empty</i> Processing...';
            submitBtn.classList.add('btn-loading');

            setTimeout(() => {
                // Clear cart
                localStorage.removeItem('cart');
                
                // Show success
                showSnackbar('✅ Payment successful! Thank you for your purchase!', 'success');
                
                setTimeout(() => {
                    window.location.href = 'order-success.html';
                }, 1500);
            }, 2000);
        });
    </script>
</body>
</html>